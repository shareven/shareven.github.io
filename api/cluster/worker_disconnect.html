<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>worker.disconnect() | Node.js API 文档</title>
  <link rel="icon" sizes="32x32" type="image/png" href="http://static.nodejs.cn/_static/img/favicon.png"><link rel="stylesheet" href="/api/api.css">
  <script>
    document.write('<link href="http://nodejs.cn/api/cluster/'&#32;+&#32;(location.port?'':'//static.nodejs.cn')&#32;+&#32;'/_static/css/api.css?1576756297748" rel="stylesheet">')
  </script>
</head>
<body class="alt apidoc" id="page_api_item">
  <div id="api-section-cluster">
    <div id="content" class="clearfix">
  
      <div id="column1" data-id="__ID__" class="interior">
        <header>
          <h1>worker.disconnect()</h1>
          <div id="gtoc">
            <ul>
              <li>v12.14.0</li>
              <li>
                <a href="../cluster.html#cluster_worker_disconnect" name="toc">返回上层文档</a>
              </li>
              <li>
                <a href="https://github.com/nodejscn/node-api-cn/edit/master/cluster/worker_disconnect.md" rel="nofollow" target="_blank">提交修改</a>
              </li>
              <li>
                <a href="http://nodejs.cn/search" name="toc">搜索</a>
              </li>
            </ul>
          </div>
          <hr>
        </header>

        <div id="biz_item"></div>
  
        <div id="apicontent">
          <div id="content_left"><div class="api_metadata">
<details class="changelog"><summary>&#x7248;&#x672C;&#x5386;&#x53F2;</summary>
<table>
<tbody><tr><th>&#x7248;&#x672C;</th><th>&#x53D8;&#x66F4;</th></tr>
<tr><td>v7.3.0</td>
<td><p>This method now returns a reference to <code>worker</code>.</p></td></tr>
<tr><td>v0.7.7</td>
<td><p><span>&#x65B0;&#x589E;&#x4E8E;: v0.7.7</span></p></td></tr>
</tbody></table>
</details>
</div><ul>
<li>Returns: <a href="http://nodejs.cn/s/uD6sLj" target="_blank" rel="nofollow" class="type">&lt;cluster.Worker&gt;</a> <code>worker</code> &#x7684;&#x5F15;&#x7528;&#x3002;</li>
</ul><p>&#x5728;&#x4E00;&#x4E2A;&#x5DE5;&#x4F5C;&#x8FDB;&#x7A0B;&#x5185;&#xFF0C;&#x8C03;&#x7528;&#x6B64;&#x65B9;&#x6CD5;&#x4F1A;&#x5173;&#x95ED;&#x6240;&#x6709;&#x7684; server&#xFF0C;&#x5E76;&#x7B49;&#x5F85;&#x8FD9;&#x4E9B; server &#x7684; <code>&apos;close&apos;</code> &#x4E8B;&#x4EF6;&#x6267;&#x884C;&#xFF0C;&#x7136;&#x540E;&#x5173;&#x95ED; IPC &#x7BA1;&#x9053;&#x3002;</p><p>&#x5728;&#x4E3B;&#x8FDB;&#x7A0B;&#x5185;&#xFF0C;&#x4F1A;&#x7ED9;&#x5DE5;&#x4F5C;&#x8FDB;&#x7A0B;&#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x5185;&#x90E8;&#x6D88;&#x606F;&#xFF0C;&#x5BFC;&#x81F4;&#x5DE5;&#x4F5C;&#x8FDB;&#x7A0B;&#x81EA;&#x8EAB;&#x8C03;&#x7528; <code>.disconnect()</code>&#x3002;</p><p>&#x4F1A;&#x8BBE;&#x7F6E; <code>.exitedAfterDisconnect</code>&#x3002;</p><p>&#x5F53;&#x4E00;&#x4E2A; server &#x5173;&#x95ED;&#x540E;&#xFF0C;&#x5B83;&#x5C06;&#x4E0D;&#x518D;&#x63A5;&#x6536;&#x65B0;&#x7684;&#x8FDE;&#x63A5;&#xFF0C;&#x4F46;&#x65B0;&#x8FDE;&#x63A5;&#x4F1A;&#x88AB;&#x5176;&#x4ED6;&#x6B63;&#x5728;&#x76D1;&#x542C;&#x7684;&#x5DE5;&#x4F5C;&#x8FDB;&#x7A0B;&#x63A5;&#x6536;&#x3002;
&#x5DF2;&#x5EFA;&#x7ACB;&#x7684;&#x8FDE;&#x63A5;&#x53EF;&#x4EE5;&#x6B63;&#x5E38;&#x5173;&#x95ED;&#x3002;
&#x5F53;&#x6240;&#x6709;&#x8FDE;&#x63A5;&#x90FD;&#x5173;&#x95ED;&#x540E;&#xFF0C;&#x901A;&#x5F80;&#x8BE5;&#x5DE5;&#x4F5C;&#x8FDB;&#x7A0B;&#x7684; IPC &#x7BA1;&#x9053;&#x5C06;&#x4F1A;&#x5173;&#x95ED;&#xFF0C;&#x5141;&#x8BB8;&#x5DE5;&#x4F5C;&#x8FDB;&#x7A0B;&#x4F18;&#x96C5;&#x5730;&#x6B7B;&#x6389;&#xFF0C;&#x8BE6;&#x89C1; <a href="http://nodejs.cn/s/3c6jjk" rel="nofollow"><code>server.close()</code></a>&#x3002;</p><p>&#x4EE5;&#x4E0A;&#x60C5;&#x51B5;&#x53EA;&#x9488;&#x5BF9;&#x670D;&#x52A1;&#x7AEF;&#x8FDE;&#x63A5;&#xFF0C;&#x5DE5;&#x4F5C;&#x8FDB;&#x7A0B;&#x4E0D;&#x4F1A;&#x81EA;&#x52A8;&#x5173;&#x95ED;&#x5BA2;&#x6237;&#x7AEF;&#x8FDE;&#x63A5;&#xFF0C;disconnect &#x65B9;&#x6CD5;&#x5728;&#x9000;&#x51FA;&#x524D;&#x5E76;&#x4E0D;&#x4F1A;&#x7B49;&#x5F85;&#x5BA2;&#x6237;&#x7AEF;&#x8FDE;&#x63A5;&#x5173;&#x95ED;&#x3002;</p><p>&#x5728;&#x5DE5;&#x4F5C;&#x8FDB;&#x7A0B;&#x4E2D;&#xFF0C;&#x4E5F;&#x5B58;&#x5728; <code>process.disconnect</code>&#xFF0C;&#x4F46;&#x5B83;&#x4E0D;&#x662F;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x5B83;&#x662F; <a href="http://nodejs.cn/s/ke6TNp" rel="nofollow"><code>disconnect()</code></a>&#x3002;</p><p>&#x56E0;&#x4E3A;&#x957F;&#x65F6;&#x95F4;&#x8FD0;&#x884C;&#x7684;&#x670D;&#x52A1;&#x7AEF;&#x8FDE;&#x63A5;&#x53EF;&#x80FD;&#x963B;&#x6B62;&#x5DE5;&#x4F5C;&#x8FDB;&#x7A0B;&#x65AD;&#x5F00;&#x8FDE;&#x63A5;&#xFF0C;&#x53EF;&#x4EE5;&#x91C7;&#x7528;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x8BA9;&#x5E94;&#x7528;&#x91C7;&#x53D6;&#x76F8;&#x5E94;&#x7684;&#x52A8;&#x4F5C;&#x6765;&#x5173;&#x95ED;&#x8FDE;&#x63A5;&#x3002;
&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8BBE;&#x7F6E;&#x8D85;&#x65F6;&#xFF0C;&#x5F53; <code>&apos;disconnect&apos;</code> &#x4E8B;&#x4EF6;&#x5728;&#x67D0;&#x6BB5;&#x65F6;&#x95F4;&#x540E;&#x4ECD;&#x6CA1;&#x6709;&#x89E6;&#x53D1;&#x65F6;&#x5173;&#x95ED;&#x5DE5;&#x4F5C;&#x8FDB;&#x7A0B;&#x3002;</p><pre><code class="language-js">if (cluster.isMaster) {
  const worker = cluster.fork();
  let timeout;

  worker.on(&apos;listening&apos;, (address) =&gt; {
    worker.send(&apos;shutdown&apos;);
    worker.disconnect();
    timeout = setTimeout(() =&gt; {
      worker.kill();
    }, 2000);
  });

  worker.on(&apos;disconnect&apos;, () =&gt; {
    clearTimeout(timeout);
  });

} else if (cluster.isWorker) {
  const net = require(&apos;net&apos;);
  const server = net.createServer((socket) =&gt; {
    // &#x8FDE;&#x63A5;&#x6C38;&#x8FDC;&#x4E0D;&#x4F1A;&#x7ED3;&#x675F;&#x3002;
  });

  server.listen(8000);

  process.on(&apos;message&apos;, (msg) =&gt; {
    if (msg === &apos;shutdown&apos;) {
      // &#x5C06;&#x6240;&#x6709;&#x4E0E;&#x670D;&#x52A1;&#x5668;&#x7684;&#x8FDE;&#x63A5;&#x4F18;&#x96C5;&#x5730;&#x5173;&#x95ED;&#x3002;
    }
  });
}
</code></pre></div>
          <div id="content_right"><div class="api_metadata">
<details class="changelog"><summary>History</summary>
<table>
<tbody><tr><th>Version</th><th>Changes</th></tr>
<tr><td>v7.3.0</td>
<td><p>This method now returns a reference to <code>worker</code>.</p></td></tr>
<tr><td>v0.7.7</td>
<td><p><span>Added in: v0.7.7</span></p></td></tr>
</tbody></table>
</details>
</div><ul>
<li>Returns: <a href="http://nodejs.cn/s/uD6sLj" target="_blank" rel="nofollow" class="type">&lt;cluster.Worker&gt;</a> A reference to <code>worker</code>.</li>
</ul><p>In a worker, this function will close all servers, wait for the <code>&apos;close&apos;</code> event
on those servers, and then disconnect the IPC channel.</p><p>In the master, an internal message is sent to the worker causing it to call
<code>.disconnect()</code> on itself.</p><p>Causes <code>.exitedAfterDisconnect</code> to be set.</p><p>After a server is closed, it will no longer accept new connections,
but connections may be accepted by any other listening worker. Existing
connections will be allowed to close as usual. When no more connections exist,
see <a href="http://nodejs.cn/s/3c6jjk" rel="nofollow"><code>server.close()</code></a>, the IPC channel to the worker will close allowing it
to die gracefully.</p><p>The above applies <em>only</em> to server connections, client connections are not
automatically closed by workers, and disconnect does not wait for them to close
before exiting.</p><p>In a worker, <code>process.disconnect</code> exists, but it is not this function;
it is <a href="http://nodejs.cn/s/ke6TNp" rel="nofollow"><code>disconnect()</code></a>.</p><p>Because long living server connections may block workers from disconnecting, it
may be useful to send a message, so application specific actions may be taken to
close them. It also may be useful to implement a timeout, killing a worker if
the <code>&apos;disconnect&apos;</code> event has not been emitted after some time.</p><pre><code class="language-js">if (cluster.isMaster) {
  const worker = cluster.fork();
  let timeout;

  worker.on(&apos;listening&apos;, (address) =&gt; {
    worker.send(&apos;shutdown&apos;);
    worker.disconnect();
    timeout = setTimeout(() =&gt; {
      worker.kill();
    }, 2000);
  });

  worker.on(&apos;disconnect&apos;, () =&gt; {
    clearTimeout(timeout);
  });

} else if (cluster.isWorker) {
  const net = require(&apos;net&apos;);
  const server = net.createServer((socket) =&gt; {
    // Connections never end
  });

  server.listen(8000);

  process.on(&apos;message&apos;, (msg) =&gt; {
    if (msg === &apos;shutdown&apos;) {
      // Initiate graceful close of any connections to server
    }
  });
}
</code></pre></div>
          <div></div>
        </div>
      </div>
    </div>
  </div>
  <script>
    document.write('<script src="http://nodejs.cn/api/cluster/'&#32;+&#32;(location.port&#32;?&#32;''&#32;:&#32;'//static.nodejs.cn')&#32;+&#32;'/_static/js/api.js?1576756297748"><\/script>');
  </script>
</body>
</html>