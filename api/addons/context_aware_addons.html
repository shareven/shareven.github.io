<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>上下文感知的插件 | Node.js API 文档</title>
  <link rel="icon" sizes="32x32" type="image/png" href="http://static.nodejs.cn/_static/img/favicon.png"><link rel="stylesheet" href="/api/api.css">
  <script>
    document.write('<link href="http://nodejs.cn/api/addons/'&#32;+&#32;(location.port?'':'//static.nodejs.cn')&#32;+&#32;'/_static/css/api.css?1576756291588" rel="stylesheet">')
  </script>
</head>
<body class="alt apidoc" id="page_api_item">
  <div id="api-section-addons">
    <div id="content" class="clearfix">
  
      <div id="column1" data-id="__ID__" class="interior">
        <header>
          <h1>上下文感知的插件</h1>
          <div id="gtoc">
            <ul>
              <li>v12.14.0</li>
              <li>
                <a href="../addons.html#addons_context_aware_addons" name="toc">返回上层文档</a>
              </li>
              <li>
                <a href="https://github.com/nodejscn/node-api-cn/edit/master/addons/context_aware_addons.md" rel="nofollow" target="_blank">提交修改</a>
              </li>
              <li>
                <a href="http://nodejs.cn/search" name="toc">搜索</a>
              </li>
            </ul>
          </div>
          <hr>
        </header>

        <div id="biz_item"></div>
  
        <div id="apicontent">
          <div id="content_left"><p>Node.js &#x63D2;&#x4EF6;&#x53EF;&#x80FD;&#x9700;&#x8981;&#x5728;&#x591A;&#x4E2A;&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#x591A;&#x6B21;&#x52A0;&#x8F7D;&#x7684;&#x73AF;&#x5883;&#x3002;
&#x6BD4;&#x5982;&#xFF0C;<a href="http://nodejs.cn/s/Fvw7Aa" rel="nofollow">Electron</a> &#x7684;&#x8FD0;&#x884C;&#x65F6;&#x4F1A;&#x5728;&#x5355;&#x4E2A;&#x8FDB;&#x7A0B;&#x4E2D;&#x8FD0;&#x884C;&#x591A;&#x4E2A; Node.js &#x5B9E;&#x4F8B;&#x3002;
&#x6BCF;&#x4E2A;&#x5B9E;&#x4F8B;&#x90FD;&#x6709;&#x5B83;&#x81EA;&#x5DF1;&#x7684; <code>require()</code> &#x7F13;&#x5B58;&#xFF0C;&#x56E0;&#x6B64;&#x5F53;&#x901A;&#x8FC7; <code>require()</code> &#x8FDB;&#x884C;&#x52A0;&#x8F7D;&#x65F6;&#xFF0C;&#x6BCF;&#x4E2A;&#x5B9E;&#x4F8B;&#x9700;&#x8981;&#x4E00;&#x4E2A;&#x539F;&#x751F;&#x7684;&#x63D2;&#x4EF6;&#x624D;&#x80FD;&#x6B63;&#x5E38;&#x8FD0;&#x884C;&#x3002;
&#x4ECE;&#x63D2;&#x4EF6;&#x7A0B;&#x5E8F;&#x7684;&#x89D2;&#x5EA6;&#x6765;&#x770B;&#xFF0C;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x5B83;&#x5FC5;&#x987B;&#x652F;&#x6301;&#x591A;&#x6B21;&#x521D;&#x59CB;&#x5316;&#x3002;</p><p>&#x53EF;&#x4EE5;&#x4F7F;&#x7528; <code>NODE_MODULE_INITIALIZER</code> &#x5B8F;&#x6765;&#x6784;&#x5EFA;&#x4E0A;&#x4E0B;&#x6587;&#x611F;&#x77E5;&#x7684;&#x63D2;&#x4EF6;&#xFF0C;&#x5B83;&#x6269;&#x5C55;&#x4E3A; Node.js &#x51FD;&#x6570;&#x7684;&#x540D;&#x5B57;&#x4F7F;&#x5F97; Node.js &#x80FD;&#x5728;&#x52A0;&#x8F7D;&#x65F6;&#x627E;&#x5230;&#x3002;
&#x53EF;&#x4EE5;&#x6309;&#x5982;&#x4E0B;&#x4F8B;&#x5B50;&#x521D;&#x59CB;&#x5316;&#x4E00;&#x4E2A;&#x63D2;&#x4EF6;&#xFF1A;</p><pre><code class="language-cpp">using namespace v8;

extern &quot;C&quot; NODE_MODULE_EXPORT void
NODE_MODULE_INITIALIZER(Local&lt;Object&gt; exports,
                        Local&lt;Value&gt; module,
                        Local&lt;Context&gt; context) {
  /* Perform addon initialization steps here. */
}
</code></pre><p>&#x53E6;&#x4E00;&#x4E2A;&#x9009;&#x62E9;&#x662F;&#x4F7F;&#x7528; <code>NODE_MODULE_INIT()</code> &#x5B8F;&#xFF0C;&#x8FD9;&#x4E5F;&#x53EF;&#x4EE5;&#x7528;&#x6765;&#x6784;&#x5EFA;&#x4E0A;&#x4E0B;&#x6587;&#x611F;&#x77E5;&#x7684;&#x63D2;&#x4EF6;&#x3002;
&#x4F46;&#x548C; <code>NODE_MODULE()</code> &#x4E0D;&#x4E00;&#x6837;&#x7684;&#x662F;&#xFF0C;&#x5B83;&#x53EF;&#x4EE5;&#x57FA;&#x4E8E;&#x4E00;&#x4E2A;&#x7ED9;&#x5B9A;&#x7684;&#x51FD;&#x6570;&#x6765;&#x6784;&#x5EFA;&#x4E00;&#x4E2A;&#x63D2;&#x4EF6;&#xFF0C; <code>NODE_MODULE_INIT()</code> &#x5145;&#x5F53;&#x4E86;&#x8FD9;&#x79CD;&#x8DDF;&#x6709;&#x51FD;&#x6570;&#x4F53;&#x7684;&#x7ED9;&#x5B9A;&#x51FD;&#x6570;&#x7684;&#x58F0;&#x660E;&#x3002;</p><p>&#x53EF;&#x4EE5;&#x5728;&#x8C03;&#x7528; <code>NODE_MODULE_INIT()</code> &#x4E4B;&#x540E;&#x5728;&#x51FD;&#x6570;&#x4F53;&#x5185;&#x90E8;&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x4E09;&#x4E2A;&#x53D8;&#x91CF;&#xFF1A;</p><ul>
<li><code>Local&lt;Object&gt; exports</code></li>
<li><code>Local&lt;Value&gt; module</code></li>
<li><code>Local&lt;Context&gt; context</code></li>
</ul><p>&#x8FD9;&#x79CD;&#x6784;&#x5EFA;&#x4E0A;&#x4E0B;&#x6587;&#x611F;&#x77E5;&#x7684;&#x63D2;&#x4EF6;&#x7684;&#x65B9;&#x5F0F;&#x987A;&#x5E26;&#x4E86;&#x7BA1;&#x7406;&#x5168;&#x5C40;&#x9759;&#x6001;&#x6570;&#x636E;&#x7684;&#x804C;&#x8D23;&#x3002;
&#x7531;&#x4E8E;&#x63D2;&#x4EF6;&#x53EF;&#x80FD;&#x88AB;&#x591A;&#x6B21;&#x52A0;&#x8F7D;&#xFF0C;&#x53EF;&#x80FD;&#x751A;&#x81F3;&#x6765;&#x81EA;&#x4E0D;&#x540C;&#x7684;&#x7EBF;&#x7A0B;&#xFF0C;&#x63D2;&#x4EF6;&#x4E2D;&#x4EFB;&#x4F55;&#x7684;&#x5168;&#x5C40;&#x9759;&#x6001;&#x6570;&#x636E;&#x5FC5;&#x987B;&#x52A0;&#x4EE5;&#x4FDD;&#x62A4;&#xFF0C;&#x5E76;&#x4E14;&#x4E0D;&#x80FD;&#x5305;&#x542B;&#x4EFB;&#x4F55;&#x5BF9; JavaScript &#x5BF9;&#x8C61;&#x6301;&#x4E45;&#x6027;&#x7684;&#x5F15;&#x7528;&#x3002;
&#x56E0;&#x4E3A; JavaScript &#x5BF9;&#x8C61;&#x53EA;&#x5728;&#x4E00;&#x4E2A;&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#x6709;&#x6548;&#xFF0C;&#x4ECE;&#x9519;&#x8BEF;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x6216;&#x8005;&#x53E6;&#x5916;&#x7684;&#x7EBF;&#x7A0B;&#x4E2D;&#x8BBF;&#x95EE;&#x6709;&#x53EF;&#x80FD;&#x4F1A;&#x5BFC;&#x81F4;&#x5D29;&#x6E83;&#x3002;</p><p>&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x6267;&#x884C;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#x6765;&#x6784;&#x9020;&#x4E0A;&#x4E0B;&#x6587;&#x611F;&#x77E5;&#x7684;&#x63D2;&#x4EF6;&#x4EE5;&#x907F;&#x514D;&#x5168;&#x5C40;&#x9759;&#x6001;&#x6570;&#x636E;&#xFF1A;</p><ul>
<li>&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x6301;&#x6709;&#x6BCF;&#x4E2A;&#x63D2;&#x4EF6;&#x5B9E;&#x4F8B;&#x6570;&#x636E;&#x7684;&#x7C7B;&#x3002;&#x8FD9;&#x6837;&#x7684;&#x7C7B;&#x5E94;&#x8BE5;&#x5305;&#x542B;&#x4E00;&#x4E2A; <code>v8::Persistent&lt;v8::Object&gt;</code> &#x6301;&#x6709; <code>exports</code> &#x5BF9;&#x8C61;&#x7684;&#x5F31;&#x5F15;&#x7528;&#x3002;&#x4E0E;&#x8BE5;&#x5F31;&#x5F15;&#x7528;&#x5173;&#x8054;&#x7684;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x5C06;&#x4F1A;&#x7834;&#x574F;&#x8BE5;&#x7C7B;&#x7684;&#x5B9E;&#x4F8B;&#x3002;</li>
<li>&#x5728;&#x63D2;&#x4EF6;&#x5B9E;&#x4F8B;&#x5316;&#x8FC7;&#x7A0B;&#x4E2D;&#x6784;&#x9020;&#x8FD9;&#x4E2A;&#x7C7B;&#x7684;&#x5B9E;&#x4F8B;&#xFF0C;&#x628A;<code>v8::Persistent&lt;v8::Object&gt;</code> &#x6302;&#x5230; <code>exports</code> &#x5BF9;&#x8C61;&#x4E0A;&#x53BB;&#x3002;</li>
<li>&#x5728; <code>v8::External</code> &#x4E2D;&#x4FDD;&#x5B58;&#x8FD9;&#x4E2A;&#x7C7B;&#x7684;&#x5B9E;&#x4F8B;&#x3002;</li>
<li>&#x901A;&#x8FC7;&#x5C06; <code>v8::External</code> &#x4F20;&#x7ED9; <code>v8::FunctionTemplate</code> &#x6784;&#x9020;&#x51FD;&#x6570;&#xFF0C;&#x8BE5;&#x51FD;&#x6570;&#x4F1A;&#x521B;&#x5EFA;&#x672C;&#x5730;&#x652F;&#x6301;&#x7684; JavaScript &#x51FD;&#x6570;&#xFF0C;&#x628A; <code>v8::External</code> &#x4F20;&#x9012;&#x7ED9;&#x6240;&#x6709;&#x66B4;&#x9732;&#x7ED9; JavaScript &#x7684;&#x65B9;&#x6CD5;&#x3002;
<code>v8::FunctionTemplate</code> &#x6784;&#x9020;&#x51FD;&#x6570;&#x7684;&#x7B2C;&#x4E09;&#x4E2A;&#x53C2;&#x6570;&#x63A5;&#x53D7; <code>v8::External</code>&#x3002;</li>
</ul><p>&#x8FD9;&#x786E;&#x4FDD;&#x4E86;&#x6BCF;&#x4E2A;&#x6269;&#x5C55;&#x5B9E;&#x4F8B;&#x6570;&#x636E;&#x5230;&#x8FBE;&#x6BCF;&#x4E2A;&#x80FD;&#x88AB; JavaScript &#x8BBF;&#x95EE;&#x7684;&#x7ED1;&#x5B9A;&#x3002;&#x6BCF;&#x4E2A;&#x6269;&#x5C55;&#x5B9E;&#x4F8B;&#x6570;&#x636E;&#x4E5F;&#x5FC5;&#x987B;&#x901A;&#x8FC7;&#x5176;&#x521B;&#x5EFA;&#x7684;&#x4EFB;&#x4F55;&#x5F02;&#x6B65;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x3002;</p><p>&#x4E0B;&#x9762;&#x7684;&#x4F8B;&#x5B50;&#x8BF4;&#x660E;&#x4E86;&#x4E00;&#x4E2A;&#x4E0A;&#x4E0B;&#x6587;&#x611F;&#x77E5;&#x7684;&#x63D2;&#x4EF6;&#x7684;&#x5B9E;&#x73B0;&#xFF1A;</p><pre><code class="language-cpp">#include &lt;node.h&gt;

using namespace v8;

class AddonData {
 public:
  AddonData(Isolate* isolate, Local&lt;Object&gt; exports):
      call_count(0) {
    // &#x5C06;&#x6B21;&#x5BF9;&#x8C61;&#x7684;&#x5B9E;&#x4F8B;&#x6302;&#x5230; exports &#x4E0A;&#x3002;
    exports_.Reset(isolate, exports);
    exports_.SetWeak(this, DeleteMe, WeakCallbackType::kParameter);
  }

  ~AddonData() {
    if (!exports_.IsEmpty()) {
      // &#x91CD;&#x65B0;&#x8BBE;&#x7F6E;&#x5F15;&#x7528;&#x4EE5;&#x907F;&#x514D;&#x6570;&#x636E;&#x6CC4;&#x9732;&#x3002;
      exports_.ClearWeak();
      exports_.Reset();
    }
  }

  // &#x6BCF;&#x4E2A;&#x63D2;&#x4EF6;&#x7684;&#x6570;&#x636E;&#x3002;
  int call_count;

 private:
  // &#x5BFC;&#x51FA;&#x5373;&#x5C06;&#x88AB;&#x56DE;&#x6536;&#x65F6;&#x8C03;&#x7528;&#x7684;&#x65B9;&#x6CD5;&#x3002;
  static void DeleteMe(const WeakCallbackInfo&lt;AddonData&gt;&amp; info) {
    delete info.GetParameter();
  }

  // &#x5BFC;&#x51FA;&#x5BF9;&#x8C61;&#x5F31;&#x53E5;&#x67C4;&#x3002;&#x8BE5;&#x7C7B;&#x7684;&#x5B9E;&#x4F8B;&#x5C06;&#x4E0E;&#x5176;&#x82E5;&#x7ED1;&#x5B9A;&#x7684; exports &#x5BF9;&#x8C61;&#x4E00;&#x8D77;&#x9500;&#x6BC1;&#x3002;
  v8::Persistent&lt;v8::Object&gt; exports_;
};

static void Method(const v8::FunctionCallbackInfo&lt;v8::Value&gt;&amp; info) {
  // &#x6062;&#x590D;&#x6BCF;&#x4E2A;&#x63D2;&#x4EF6;&#x5B9E;&#x4F8B;&#x7684;&#x6570;&#x636E;&#x3002;
  AddonData* data =
      reinterpret_cast&lt;AddonData*&gt;(info.Data().As&lt;External&gt;()-&gt;Value());
  data-&gt;call_count++;
  info.GetReturnValue().Set((double)data-&gt;call_count);
}

// context-aware &#x521D;&#x59CB;&#x5316;
NODE_MODULE_INIT(/* exports, module, context */) {
  Isolate* isolate = context-&gt;GetIsolate();

  // &#x4E3A;&#x8BE5;&#x6269;&#x5C55;&#x5B9E;&#x4F8B;&#x7684;AddonData&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x5B9E;&#x4F8B;
  AddonData* data = new AddonData(isolate, exports);
  // &#x5728; v8::External &#x4E2D;&#x5305;&#x88F9;&#x6570;&#x636E;&#xFF0C;&#x8FD9;&#x6837;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x5C06;&#x5B83;&#x4F20;&#x9012;&#x7ED9;&#x6211;&#x4EEC;&#x66B4;&#x9732;&#x7684;&#x65B9;&#x6CD5;&#x3002;
  Local&lt;External&gt; external = External::New(isolate, data);

  // &#x628A; &quot;Method&quot; &#x65B9;&#x6CD5;&#x66B4;&#x9732;&#x7ED9; JavaScript&#xFF0C;&#x5E76;&#x786E;&#x4FDD;&#x5176;&#x63A5;&#x6536;&#x6211;&#x4EEC;&#x901A;&#x8FC7;&#x628A; `external` &#x4F5C;&#x4E3A; FunctionTemplate &#x6784;&#x9020;&#x51FD;&#x6570;&#x7B2C;&#x4E09;&#x4E2A;&#x53C2;&#x6570;&#x65F6;&#x521B;&#x5EFA;&#x7684;&#x6BCF;&#x4E2A;&#x63D2;&#x4EF6;&#x5B9E;&#x4F8B;&#x7684;&#x6570;&#x636E;&#x3002;
  exports-&gt;Set(context,
               String::NewFromUtf8(isolate, &quot;method&quot;, NewStringType::kNormal)
                  .ToLocalChecked(),
               FunctionTemplate::New(isolate, Method, external)
                  -&gt;GetFunction(context).ToLocalChecked()).FromJust();
}
</code></pre></div>
          <div id="content_right"><p>There are environments in which Node.js addons may need to be loaded multiple
times in multiple contexts. For example, the <a href="http://nodejs.cn/s/Fvw7Aa" rel="nofollow">Electron</a> runtime runs multiple
instances of Node.js in a single process. Each instance will have its own
<code>require()</code> cache, and thus each instance will need a native addon to behave
correctly when loaded via <code>require()</code>. From the addon&apos;s perspective, this means
that it must support multiple initializations.</p><p>A context-aware addon can be constructed by using the macro
<code>NODE_MODULE_INITIALIZER</code>, which expands to the name of a function which Node.js
will expect to find when it loads an addon. An addon can thus be initialized as
in the following example:</p><pre><code class="language-cpp">using namespace v8;

extern &quot;C&quot; NODE_MODULE_EXPORT void
NODE_MODULE_INITIALIZER(Local&lt;Object&gt; exports,
                        Local&lt;Value&gt; module,
                        Local&lt;Context&gt; context) {
  /* Perform addon initialization steps here. */
}
</code></pre><p>Another option is to use the macro <code>NODE_MODULE_INIT()</code>, which will also
construct a context-aware addon. Unlike <code>NODE_MODULE()</code>, which is used to
construct an addon around a given addon initializer function,
<code>NODE_MODULE_INIT()</code> serves as the declaration of such an initializer to be
followed by a function body.</p><p>The following three variables may be used inside the function body following an
invocation of <code>NODE_MODULE_INIT()</code>:</p><ul>
<li><code>Local&lt;Object&gt; exports</code>,</li>
<li><code>Local&lt;Value&gt; module</code>, and</li>
<li><code>Local&lt;Context&gt; context</code></li>
</ul><p>The choice to build a context-aware addon carries with it the responsibility of
carefully managing global static data. Since the addon may be loaded multiple
times, potentially even from different threads, any global static data stored
in the addon must be properly protected, and must not contain any persistent
references to JavaScript objects. The reason for this is that JavaScript
objects are only valid in one context, and will likely cause a crash when
accessed from the wrong context or from a different thread than the one on which
they were created.</p><p>The context-aware addon can be structured to avoid global static data by
performing the following steps:</p><ul>
<li>defining a class which will hold per-addon-instance data. Such
a class should include a <code>v8::Persistent&lt;v8::Object&gt;</code> which will hold a weak
reference to the addon&apos;s <code>exports</code> object. The callback associated with the weak
reference will then destroy the instance of the class.</li>
<li>constructing an instance of this class in the addon initializer such that the
<code>v8::Persistent&lt;v8::Object&gt;</code> is set to the <code>exports</code> object.</li>
<li>storing the instance of the class in a <code>v8::External</code>, and</li>
<li>passing the <code>v8::External</code> to all methods exposed to JavaScript by passing it
to the <code>v8::FunctionTemplate</code> constructor which creates the native-backed
JavaScript functions. The <code>v8::FunctionTemplate</code> constructor&apos;s third parameter
accepts the <code>v8::External</code>.</li>
</ul><p>This will ensure that the per-addon-instance data reaches each binding that can
be called from JavaScript. The per-addon-instance data must also be passed into
any asynchronous callbacks the addon may create.</p><p>The following example illustrates the implementation of a context-aware addon:</p><pre><code class="language-cpp">#include &lt;node.h&gt;

using namespace v8;

class AddonData {
 public:
  AddonData(Isolate* isolate, Local&lt;Object&gt; exports):
      call_count(0) {
    // Link the existence of this object instance to the existence of exports.
    exports_.Reset(isolate, exports);
    exports_.SetWeak(this, DeleteMe, WeakCallbackType::kParameter);
  }

  ~AddonData() {
    if (!exports_.IsEmpty()) {
      // Reset the reference to avoid leaking data.
      exports_.ClearWeak();
      exports_.Reset();
    }
  }

  // Per-addon data.
  int call_count;

 private:
  // Method to call when &quot;exports&quot; is about to be garbage-collected.
  static void DeleteMe(const WeakCallbackInfo&lt;AddonData&gt;&amp; info) {
    delete info.GetParameter();
  }

  // Weak handle to the &quot;exports&quot; object. An instance of this class will be
  // destroyed along with the exports object to which it is weakly bound.
  v8::Persistent&lt;v8::Object&gt; exports_;
};

static void Method(const v8::FunctionCallbackInfo&lt;v8::Value&gt;&amp; info) {
  // Retrieve the per-addon-instance data.
  AddonData* data =
      reinterpret_cast&lt;AddonData*&gt;(info.Data().As&lt;External&gt;()-&gt;Value());
  data-&gt;call_count++;
  info.GetReturnValue().Set((double)data-&gt;call_count);
}

// Initialize this addon to be context-aware.
NODE_MODULE_INIT(/* exports, module, context */) {
  Isolate* isolate = context-&gt;GetIsolate();

  // Create a new instance of AddonData for this instance of the addon.
  AddonData* data = new AddonData(isolate, exports);
  // Wrap the data in a v8::External so we can pass it to the method we expose.
  Local&lt;External&gt; external = External::New(isolate, data);

  // Expose the method &quot;Method&quot; to JavaScript, and make sure it receives the
  // per-addon-instance data we created above by passing `external` as the
  // third parameter to the FunctionTemplate constructor.
  exports-&gt;Set(context,
               String::NewFromUtf8(isolate, &quot;method&quot;, NewStringType::kNormal)
                  .ToLocalChecked(),
               FunctionTemplate::New(isolate, Method, external)
                  -&gt;GetFunction(context).ToLocalChecked()).FromJust();
}
</code></pre></div>
          <div></div>
        </div>
      </div>
    </div>
  </div>
  <script>
    document.write('<script src="http://nodejs.cn/api/addons/'&#32;+&#32;(location.port&#32;?&#32;''&#32;:&#32;'//static.nodejs.cn')&#32;+&#32;'/_static/js/api.js?1576756291588"><\/script>');
  </script>
</body>
</html>